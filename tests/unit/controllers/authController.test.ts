import { Request, Response } from 'express';
import passport from 'passport';
import { loginUser } from '../../../src/controllers/authController';
import { generateAuthToken } from '../../../src/services/authService';

jest.mock('passport', () => ({
  authenticate: jest.fn((strategy, options, callback) => jest.fn())
}));
jest.mock('../../../src/services/authService');

describe('Login User', () => {
  it('should return a token if authentication is successful', async () => {
    // Simulate the request and response
    const req = {
      body: {
        email: 'test@example.com',
        password: 'password',
      },
    } as unknown as Request;

    const res = {
      status: jest.fn().mockReturnThis(),
      json: jest.fn(),
    } as unknown as Response;

    // Simulate the user returned by passport.authenticate
    const mockUser = {
      id: 1,
      email: 'test@example.com',
    };

    // Simulate the token generated by generateAuthToken
    const mockToken = 'token';

    (passport.authenticate as jest.Mock).mockImplementation((strategy, options, callback) => {
      callback(null, mockUser);
      return (req: Request, res: Response) => {};
    });

    (generateAuthToken as jest.Mock).mockReturnValue(mockToken);

    await loginUser(req, res);

    // Verify that generateAuthToken was called with the correct arguments
    expect(res.json).toHaveBeenCalledWith({ token: mockToken });
  });

  it('should return 401 if authentication fails', async () => {
    const req = {
      body: {
        email: 'test@example.com',
        password: 'password',
      },
    } as unknown as Request;

    const res = {
      status: jest.fn().mockReturnThis(),
      json: jest.fn(),
    } as unknown as Response;

    // Simulate that passport.authenticate returns an internal error
    const mockError = new Error('Some internal error');
    (passport.authenticate as jest.Mock).mockImplementation((strategy, options, callback) => {
      callback(mockError, null);
      return (req: Request, res: Response) => {};
    });

    await loginUser(req, res);

    // Verify that an error response was sent
    expect(res.status).toHaveBeenCalledWith(500);
    expect(res.json).toHaveBeenCalledWith({ message: 'Internal Server Error' });
  });

  it('should return 401 if credentials are incorrect', async () => {
    const req = {
      body: {
        email: 'test@example.com',
        password: 'password',
      },
    } as unknown as Request;

    const res = {
      status: jest.fn().mockReturnThis(),
      json: jest.fn(),
    } as unknown as Response;

    // Simulate that passport.authenticate returns null user and error
    (passport.authenticate as jest.Mock).mockImplementation((strategy, options, callback) => {
      callback(null, null);
      return (req: Request, res: Response) => {};
    });

    await loginUser(req, res);

    // Verify that an Unauthorized error response was sent
    expect(res.status).toHaveBeenCalledWith(401);
    expect(res.json).toHaveBeenCalledWith({ message: 'Invalid email or password' });
  });
});
